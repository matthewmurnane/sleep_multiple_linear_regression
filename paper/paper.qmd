---
title: "Multiple Linear Regression on Sleep Data"
author:
  - name: Ethan Newcomb
  - name: Kyubin Im
  - name: Matthew Murnane
format:
  pdf:
    mainfont: "Times New Roman"
indent: true
fontsize: "12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
#Packages
library(tidyverse)
library(dplyr)
library(ggthemes)
library(tidyr)
library(knitr)
library(kableExtra)
library(car)
library(MASS)
library(readr)
library(janitor)
library(patchwork)
library(broom)
```

```{r include=FALSE}
#Data Wrangling Code
sleep <- read_csv("../data/Sleep_health_and_lifestyle_dataset.csv") %>%  
  clean_names()

sleep <- sleep %>%
  separate(blood_pressure, into = c("systolic", "diastolic"), sep = "/", convert = TRUE)

sleep$stress_level <- as.factor(sleep$stress_level)
sleep$quality_of_sleep <- as.factor(sleep$quality_of_sleep)

sleep <- sleep %>%
  mutate(systolic = as.numeric(systolic),
         diastolic = as.numeric(diastolic),
         PP = systolic-diastolic)

sleep <- sleep %>%
  dplyr::select(!c(person_id, systolic, diastolic))
```

\newpage

\noindent\textbf{\Large Motivation}

\vspace{0.5em}

Sleep is an important contributor to our well-being and is deeply connected to our physical health, and cognitive function. However we often find that many individuals struggle with getting long hours sleep, often finding themselves tossing and turning throughout the night. Consequently, there is now a growing interest in understanding the lifestyle and bio metric factors that influence sleep patterns and duration. General knowledge and intuition suggest factors such as physical activity and occupational stress may influence sleep duration. Therefore, our goal is to use linear regression techniques to quantify exactly how much these factors reduce or extend sleep time.

Before, analyzing the data set, we expect a number of our indicators to contribute significantly to sleep duration. In general, we would assume that occupation will play an important role in analyzing our data as a more stressful work environment may hinder sleep patterns and disturb the body's natural sleep cycle. Additionally, we may expect that higher levels of physical activity will work in tandem with deeper and longer duration of sleep.

Also, we seek to filter through and find the most important variables in our analysis. We expect that variables like Daily Steps and Physical Activity Level will be a contribute to sleep duration in a similar manner. In our data set, we have numerous combinations of variables that are alike in this way and therefore we want to reduce our factors to give the most precise and simple model possible.

\vspace{1.5em}

\noindent\textbf{\Large About the Data}

```{r}
#Table 1: Variables in Sleep
variable_names <- matrix(c(
  "Gender", "Age", "Occupation",
  "Sleep Duration (hours)", "Quality of Sleep (scale: 1–10)", "Physical Activity Level (minutes/day)",
  "Stress Level (scale: 1–10)", "BMI Category", "PP (Pulse Pressure)",
  "Heart Rate (bpm)", "Daily Steps", "Sleep Disorder"
), ncol = 3, byrow = TRUE)

kable(variable_names, col.names = NULL, caption = "Variables From Our Data")
```

Sleep Duration is a continuous variable and will be our response variable. The rest will be our covariates. Gender, Occupation, Quality of Sleep, Stress Level, BMI Category and Sleep Disorder are categorical variables. Physical Activity, PP, agem and Daily steps are continuous variables. We have a total of 374 observations.

We had no missing data in the data set but we did have to make a mutation using `dplyr`. In the original data set there was a blood pressure variable that was encoded as a character but was a ratio, e.g. "$\frac{120}{80}$". We separated the blood pressure variable into two: Systolic and Diastolic. These two we suspected to be highly correlated but did not want to just drop one or the other. We had options of combining the two into something meaningful. One was Pulse Pressure (PP), which is calculated as $\text{PP}=\text{systolic}-\text{diastolic}$. PP is the force of the hearts contraction on the arteries. The other is called Mean Arterial Pressure (MAP), which is calculated as $\text{MAP}=\frac{\text{systolic}\cdot\text{diastolic}^2}{3}$. MAP is the average blood pressure throughout a cardiac cycle. We decided on PP because it was simpler to calculate and understand.

For transparency it should be noted that the data is synthetic. Even though it is synthetic we still treat the analysis and report as if it was real data.


\vspace{1.5em}

\noindent\textbf{\Large Exploratory Data Analysis}

```{r}
p1 <- sleep %>% 
  ggplot() +
  geom_jitter(aes(x = age, y = sleep_duration), size = .5) +
  theme_few() +
  labs(x = "Age", y = NULL)

p2 <- sleep %>% 
  ggplot() +
  geom_jitter(aes(x = PP, y = sleep_duration), size = .5) +
  theme_few() +
  labs(x = "Pulse Pressure", y = NULL)

p3 <- sleep %>% 
  ggplot() +
  geom_jitter(aes(x = heart_rate, y = sleep_duration), size = .5) +
  theme_few() +
  labs(x = "Heart Rate", y = NULL)

p4 <- sleep %>% 
  ggplot() +
  geom_jitter(aes(x = daily_steps, y = sleep_duration), size = .5) +
  theme_few() +
  labs(x = "Daily Steps", y = NULL)

(p1 + p2) / (p3 + p4) +
  plot_annotation(
    title = "Sleep Duration vs Continuous Variables",
    theme = theme(plot.title = element_text(size = 16, hjust = 0.5))
  ) &
  theme(axis.title.y = element_text(angle = 90)) &
  labs(y = "Sleep Duration")
```

```{r}
corr_vars <- sleep %>%
  dplyr::select(sleep_duration, age, PP, heart_rate, daily_steps)

corr_matrix <- round(cor(corr_vars, use = "complete.obs"), 2)

knitr::kable(corr_matrix, caption = "Correlation Matrix of Continuous Varaibles")
```

\vspace{1.5em}

\noindent\textbf{\Large Full Model}

Running the full model we can see that our omnibus hypothesis test has an F-stat of 426.6 which is greater than the 99th percentile for our F-distribution, $F_{31,342,.99}=$ `r round(qf(0.99, 31, 342),2)`. So we reject the null that all coefficients are 0. We also see a high Adjusted $R^2$ and very low Residual Sum of Squares compared to the Total Sum of Squares. 

```{r}
# Fit the model
full_model <- lm(sleep_duration ~ ., data = sleep)

# Get summary
model_summary <- summary(full_model)

model_stats <- tibble::tibble(`F-statistic` = round(model_summary$fstatistic[1], 2),
                              `Adjusted R²` = round(model_summary$adj.r.squared, 3),
                              `Residual Sum of Squares` = round(sum(residuals(full_model)^2), 2),
                              `Total Sum of Squares` = round(sum((sleep$sleep_duration - mean(sleep$sleep_duration))^2), 2))

knitr::kable(model_stats, caption = "Full Linear Model Outcome")
```

As far as assumptions go heteroskadcity seems to be true and normality might be slightly violated with heavy tails but their is no excessive deviation from normality.

```{r}
# Extract model diagnostics
model_data <- augment(full_model)

# Residuals vs Fitted plot
p5 <- ggplot(model_data, aes(.fitted, .resid)) +
  geom_point(size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_few() +
  labs(title = "Residuals vs Fitted",
       x = "Fitted values", y = "Residuals")

# Q-Q plot
p6 <- ggplot(model_data, aes(sample = .resid)) +
  stat_qq(size = 1) +
  stat_qq_line() +
  theme_few() +
  labs(title = "Normal Q-Q Plot", x = "Theoretical Quantiles", y = "Sample Quantiles")

# Combine with patchwork
p5 / p6
```

